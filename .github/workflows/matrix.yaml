  name: matrix
  on:
    pull_request:
      branches: [ 'main' ]
      types: [opened, synchronize, reopened, closed, labeled, unlabeled]

  jobs:
    build:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          platform:
            - i386 
            - arm64v8
      steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2  

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
        - name: Generate Tag Output
          id: tag_output
          run: echo "::set-output name=tag::${{ matrix.platform }}"

        # Login against a Docker registry except on PR
        # https://github.com/docker/login-action
        - name: Log into
          uses: docker/login-action@v2
          with:
            username: serbenyuk
            password: ${{ secrets.DOCKERHUB_PASSWORD }}

        # Extract metadata (tags, labels) for Docker
        # https://github.com/docker/metadata-action
        - name: Extract Docker metadata
          id: meta
          uses: docker/metadata-action@v4.4.0
          with:
            images: serbenyuk/new
            labels: |
              org.opencontainers.image.revision=${{ env.SHA }}
            tags: |
              type=edge,branch=$repo.default_branch
              type=semver,pattern=v{{version}}
              type=sha,prefix=,suffix=,format=short
        
        # Build and push Docker image with Buildx (don't push on PR)
        # https://github.com/docker/build-push-action
        - name: Build and push Docker image
          id: build
          uses: docker/build-push-action@v4.0.0
          with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
            build-args: |
              PLATFORM=${{ matrix.platform }}

        ## Write for matrix outputs workaround 
        - uses: cloudposse/github-action-matrix-outputs-write@0.3.1
          id: out
          with:
            matrix-step-name: ${{ github.job }}
            matrix-key: ${{ matrix.platform }}
            outputs: |
              image: ${{ steps.build.outputs.image }}:${{ steps.build.outputs.tag }}

    # ## Read matrix outputs 
    # read:
    #   runs-on: ubuntu-latest
    #   needs: [build]
    #   steps:
    #     - uses: cloudposse/github-action-matrix-outputs-read@main
    #       id: read
    #       with:
    #         matrix-step-name: build

    #   outputs:
    #     result: "${{ steps.read.outputs.result }}"

    ## This how you can reference matrix output
    # assert:
    #   runs-on: ubuntu-latest
    #   needs: [read]
    #   steps:
    #     - uses: nick-fields/assert-action@v1
    #       with:
    #         expected: ${{ registry.hub.docker.com }}/${{ github.event.repository.owner.login }}/${{ github.event.repository.name }}:i386
    #         ## This how you can reference matrix output
    #         actual: ${{ fromJson(needs.read.outputs.result).image.i386 }}

    #     - uses: nick-fields/assert-action@v1
    #       with:
    #         expected: ${{ registry.hub.docker.com }}/${{ github.event.repository.owner.login }}/${{ github.event.repository.name }}:arm64v8
    #         ## This how you can reference matrix output
    #         actual: ${{ fromJson(needs.read.outputs.result).image.arm64v8 }}